<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Trang cá nhân - Hair Harmony</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css}" rel="stylesheet">
  <link th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css}" rel="stylesheet">
  <link th:href="@{/css/styles.css}" rel="stylesheet"> <!-- nếu muốn dùng CSS chung -->
  <style>
    body {background: #EAE7D6;}
    .profile-wrap {max-width: 950px; margin: 38px auto; background: #fff; border-radius: 18px; box-shadow: 0 2px 18px #5d7b6f1b; padding: 32px 32px 30px 32px;}
    .profile-header {display:flex;align-items:center;gap:24px;margin-bottom: 30px;}
    .profile-avatar {width: 90px;height:90px;border-radius:50%;object-fit:cover;box-shadow:0 2px 8px #b0d4b839;}
    .profile-info {flex:1;}
    .profile-name {font-size:1.4rem;color:#5D7B6F;font-weight:700;}
    .profile-points {color:#A4C3A2;font-weight:600;}
    .nav-tabs .nav-link.active {background:#B0D4B8;color:#fff;font-weight:600;}
    .tab-pane {padding-top:18px;}
    .table th, .table td {vertical-align:middle;}
    .status-booked {color:#fff;background:#5D7B6F;padding:3px 10px;border-radius:10px;}
    .status-done {color:#fff;background:#A4C3A2;padding:3px 10px;border-radius:10px;}
    .status-cancel {color:#fff;background:#bb5555;padding:3px 10px;border-radius:10px;}
    .btn-profile {background:#5D7B6F;color:#fff;}
    .btn-profile:hover {background:#A4C3A2;}
    @media (max-width:700px) {.profile-wrap{padding:8px;}}
  </style>
</head>
<body>

<!-- HEADER -->
<div th:replace="~{fragments/header :: siteHeader}"></div>

<div class="profile-wrap">
  <div class="profile-header">
    <img th:src="${#strings.isEmpty(user.avatar) ? 'https://i.pravatar.cc/120?img=42' : user.avatar}"
         class="profile-avatar" alt="avatar"/>

    <div class="profile-info">
      <div class="profile-name" th:text="${#strings.isEmpty(user.fullName) ? user.username : user.fullName}">Tên người dùng</div>
      <div><i class="fa-solid fa-envelope"></i> <span th:text="${user.email}">email@example.com</span></div>
      <div><i class="fa-solid fa-phone"></i> <span th:text="${user.phone}">09xx xxx xxx</span></div>
      <div class="profile-points mt-1"><i class="fa-solid fa-gift"></i> Điểm thưởng:
        <span th:text="${points}">0</span> điểm
      </div>
    </div>

    <div>
      <a class="btn btn-profile btn-sm" th:href="@{/profile/edit}"><i class="fa fa-edit"></i> Sửa thông tin</a>
      <!-- nút logout nếu cần ngay tại trang, hoặc dùng logout ở header -->
      <form th:action="@{/logout}" method="post" class="d-inline ms-2">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <button class="btn btn-secondary btn-sm"><i class="fa fa-sign-out"></i> Đăng xuất</button>
      </form>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="profileTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button" role="tab">Lịch đặt của tôi</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="feedbacks-tab" data-bs-toggle="tab" data-bs-target="#feedbacks" type="button" role="tab">Đánh giá của tôi</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="support-tab" data-bs-toggle="tab" data-bs-target="#support" type="button" role="tab">Hỗ trợ đã gửi</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">Cài đặt</button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Lịch sử đặt lịch -->
    <div class="tab-pane fade show active" id="bookings" role="tabpanel">
      <h5 class="mt-2 mb-2" style="color:#5D7B6F;">Lịch sử đặt lịch</h5>

      <div th:if="${#lists.isEmpty(bookings)}" class="text-muted">Bạn chưa có lịch đặt nào.</div>

      <table class="table table-bordered table-hover align-middle" th:if="${!#lists.isEmpty(bookings)}">
        <thead>
        <tr style="background:#B0D4B8;color:#fff;">
          <th>Ngày</th><th>Stylist</th><th>Dịch vụ</th><th>Giá</th><th>Trạng thái</th><th>Đánh giá</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="b : ${bookings}">
          <td th:text="${b.dateStr}">23/07/2025 10:00</td>
          <td th:text="${b.stylistName}">Ngọc Hà</td>
          <td th:text="${b.serviceNames}">Cắt, Gội</td>
          <td th:text="${#numbers.formatDecimal(b.total, 0, 'COMMA', 2, 'POINT')}">120,000.00</td>
          <td>
            <span th:if="${b.status == 'DONE'}" class="status-done">Đã hoàn thành</span>
            <span th:if="${b.status == 'CONFIRMED' or b.status == 'PENDING'}" class="status-booked">Đã đặt</span>
            <span th:if="${b.status == 'CANCELLED' or b.status == 'NO_SHOW'}" class="status-cancel">Đã hủy</span>
          </td>
          <td>
            <span th:if="${b.status == 'DONE'}">
              <span th:if="${b.feedbackGiven}" class="text-success">
                <i class="fa fa-check-circle"></i> Đã đánh giá
              </span>
              <a th:if="${!b.feedbackGiven}" class="btn btn-sm btn-profile"
                 th:href="@{'/feedback/new?bookingId=' + ${b.id}}">
                Đánh giá
              </a>
            </span>
            <span th:if="${b.status != 'DONE'}" class="text-muted">-</span>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Feedback của tôi -->
    <div class="tab-pane fade" id="feedbacks" role="tabpanel">
      <h5 class="mt-2 mb-2" style="color:#5D7B6F;">Đánh giá bạn đã gửi</h5>
      <div th:if="${#lists.isEmpty(feedbacks)}" class="text-muted">Chưa có đánh giá nào.</div>
      <ul class="list-group" th:if="${!#lists.isEmpty(feedbacks)}">
        <li class="list-group-item" th:each="f : ${feedbacks}">
          <b th:text="${f.serviceNames}">Dịch vụ</b>
          <span class="text-muted" th:text="'(' + ${f.dateStr} + ')'"> (23/07/2025)</span><br>
          <span th:utext="${#strings.repeat('<i class=&quot;fa-solid fa-star&quot; style=&quot;color:#F9B801&quot;></i>', f.rating)}"></span>
          <span class="ms-2" th:text="${f.comment}">Nội dung</span>
          <div class="mt-1 text-success" th:if="${!#strings.isEmpty(f.reply)}">
            <i class="fa fa-reply"></i> Salon: <span th:text="${f.reply}">Cảm ơn bạn</span>
          </div>
        </li>
      </ul>
    </div>

    <!-- Hỗ trợ đã gửi -->
    <div class="tab-pane fade" id="support" role="tabpanel">
      <h5 class="mt-2 mb-2" style="color:#5D7B6F;">Yêu cầu hỗ trợ đã gửi</h5>
      <div th:if="${#lists.isEmpty(supports)}" class="text-muted">Chưa có yêu cầu hỗ trợ nào.</div>
      <ul class="list-group" th:if="${!#lists.isEmpty(supports)}">
        <li class="list-group-item" th:each="s : ${supports}">
          <b th:text="${s.title}">Tiêu đề</b>
          <span class="text-muted" th:text="'(' + ${s.dateStr} + ')'"> (21/07/2025)</span>
          <span class="badge ms-2" th:text="${s.status}"
                th:classappend="${s.status == 'RESOLVED' or s.status == 'CLOSED'} ? ' bg-success' : ' bg-secondary'">RESOLVED</span>
          <div class="mt-1 text-success" th:if="${!#strings.isEmpty(s.answer)}">
            <i class="fa fa-reply"></i> Trả lời: <span th:text="${s.answer}">Nội dung trả lời</span>
          </div>
        </li>
      </ul>
    </div>

    <!-- Cài đặt -->
    <div class="tab-pane fade" id="settings" role="tabpanel">
      <h5 class="mt-2 mb-2" style="color:#5D7B6F;">Cài đặt tài khoản</h5>
      <a class="btn btn-danger btn-sm" th:href="@{/profile/password}">
        <i class="fa fa-lock"></i> Đổi mật khẩu
      </a>
      <span class="ms-2 text-secondary">Hoặc liên hệ hỗ trợ để được giúp đổi email, số điện thoại.</span>
    </div>
  </div>
</div>

<!-- FOOTER -->
<div th:replace="~{fragments/footer :: siteFooter}"></div>

<script th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
